module Analyze.Waves

let private dot a b =
  Array.map2 (fun x y -> x * y) a b |> Array.sum

let private window i n (arr: 'a []) =
  [| for j in 0 .. n - 1 do yield arr.[i + j] |]

let private wrap n (arr: 'a []) =
  let l = Array.length arr
  [| for j in -(n >>> 1) .. (n >>> 1) - 1 do
        if j < 0 then
            yield arr.[l + j]
        else
            yield arr.[j] |]

// See http://fsharpnews.blogspot.dk/2006/12/array-manipulation-continued.html
let rec private transform h g a n =
  let d = h |> Array.length
  if n > d then
    let n2 = n >>> 1 in
    let tmp = Array.create n 0.
    for i = 0 to (n2 - d / 2) - 1 do
      let win = window (i * 2) d a
      tmp.[i] <- dot win h
      tmp.[i + n2] <- dot win g
    let wrap = wrap d a
    tmp.[n2 - 1] <- dot wrap h
    tmp.[2 * n2 - 1] <- dot wrap g
    Array.blit tmp 0 a 0 n;
    transform h g a n2
  else
    a

let d2 a =
  let h = [| -0.12940952255092145; 0.22414386804185735;
           0.836516303737469; 0.48296291314469025 |]
  let g = [| -0.48296291314469025; 0.836516303737469;
           -0.22414386804185735; -0.12940952255092145 |]
  transform h g a (Array.length a)

let d4 a =
  let h = [| -0.010597401784997278; 0.032883011666982945; 0.030841381835986965;
           -0.18703481171888114; -0.02798376941698385; 0.6308807679295904;
           0.7148465705525415; 0.23037781330885523 |]
  let g = [| -0.23037781330885523; 0.7148465705525415; -0.6308807679295904;
           -0.02798376941698385; 0.1870348117188811; 0.030841381835986965;
           -0.032883011666982945; -0.010597401784997278 |]
  transform h g a (Array.length a)

let d7 a =
  let h = [| 0.0003537138000010399; -0.0018016407039998328; 0.00042957797300470274;
           0.012550998556013784; -0.01657454163101562; -0.03802993693503463;
           0.0806126091510659; 0.07130921926705004; -0.22403618499416572;
           -0.14390600392910627; 0.4697822874053586; 0.7291320908465551;
           0.39653931948230575; 0.07785205408506236 |]
  let g = [| -0.07785205408506236; 0.39653931948230575; -0.7291320908465551;
           0.4697822874053586; 0.14390600392910627; -0.22403618499416572;
           -0.07130921926705004; 0.0806126091510659; 0.03802993693503463;
           -0.01657454163101562; -0.012550998556013784; 0.00042957797300470274;
           0.0018016407039998328; 0.0003537138000010399 |]
  transform h g a (Array.length a)

let d16 a =
  let h = [|-2.1093396300980412e-08; 2.3087840868545578e-07; -7.363656785441815e-07;
           -1.0435713423102517e-06; 1.133660866126152e-05; -1.394566898819319e-05;
           -6.103596621404321e-05; 0.00017478724522506327; 0.00011424152003843815;
           -0.0009410217493585433; 0.00040789698084934395; 0.00312802338120381;
           -0.0036442796214883506; -0.006990014563390751; 0.013993768859843242;
           0.010297659641009963; -0.036888397691556774; -0.007588974368642594;
           0.07592423604445779; -0.006239722752156254; -0.13238830556335474;
           0.027340263752899923; 0.21119069394696974; -0.02791820813292813;
           -0.3270633105274758; -0.08975108940236352; 0.44029025688580486;
           0.6373563320829833; 0.43031272284545874; 0.1650642834886438;
           0.03490771432362905; 0.0031892209253436892
           |]
  let g = [|-0.0031892209253436892; 0.03490771432362905; -0.1650642834886438;
           0.43031272284545874; -0.6373563320829833; 0.44029025688580486;
           0.08975108940236352; -0.3270633105274758; 0.02791820813292813;
           0.21119069394696974; -0.027340263752899923; -0.13238830556335474;
           0.006239722752156254; 0.07592423604445779; 0.007588974368642594;
           -0.036888397691556774; -0.010297659641009963; 0.013993768859843242;
           0.006990014563390751; -0.0036442796214883506; -0.00312802338120381;
           0.00040789698084934395; 0.0009410217493585433; 0.00011424152003843815;
           -0.00017478724522506327; -6.103596621404321e-05; 1.394566898819319e-05;
           1.133660866126152e-05; 1.0435713423102517e-06; -7.363656785441815e-07;
           -2.3087840868545578e-07; -2.1093396300980412e-08
           |]
  transform h g a (Array.length a)
