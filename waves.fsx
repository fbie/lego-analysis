module Waves =
  let private dot a b =
    Array.map2 (fun x y -> x * y) a b |> Array.sum

  let private window i n (arr: 'a []) =
    [| for j in 0 .. n - 1 do yield arr.[i + j] |]

  let private wrap n (arr: 'a []) =
    let l = Array.length arr - 1
    [| for j in -(n >>> 1) .. (n >>> 1) - 1 do yield if j < 0 then arr.[l + j] else arr.[j] |]

  // See http://fsharpnews.blogspot.dk/2006/12/array-manipulation-continued.html
  let rec private transform h g a n =
    let n2 = n >>> 1 in
    let d = Array.length h
    let tmp = Array.create n 0.
    for i = 0 to (n2 - d / 2) - 1 do
      let win = window (i * 2) d a
      tmp.[i] <- dot win h
      tmp.[i + n2] <- dot win g
    let wrap = wrap d a
    tmp.[n2 - 1] <- dot wrap h
    tmp.[2 * n2 - 1] <- dot wrap g
    Array.blit tmp 0 a 0 n;
    if n > d then transform h g a n2 else a

  let d2 a =
    let h = [| -0.12940952255092145; 0.22414386804185735; 0.836516303737469; 0.48296291314469025 |]
    let g = [| -0.48296291314469025; 0.836516303737469; -0.22414386804185735; -0.12940952255092145 |]
    transform h g a (Array.length a)

  let d4 a =
    let h = [| -0.010597401784997278; 0.032883011666982945; 0.030841381835986965; -0.18703481171888114; -0.02798376941698385; 0.6308807679295904; 0.7148465705525415; 0.23037781330885523 |]
    let g = [| -0.23037781330885523; 0.7148465705525415; -0.6308807679295904; -0.02798376941698385; 0.1870348117188811; 0.030841381835986965; -0.032883011666982945; -0.010597401784997278 |]
    transform h g a (Array.length a)

  let d7 a =
    let h = [| 0.0003537138000010399; -0.0018016407039998328; 0.00042957797300470274; 0.012550998556013784; -0.01657454163101562; -0.03802993693503463; 0.0806126091510659; 0.07130921926705004; -0.22403618499416572; -0.14390600392910627; 0.4697822874053586; 0.7291320908465551; 0.39653931948230575; 0.07785205408506236 |]
    let g = [| -0.07785205408506236; 0.39653931948230575; -0.7291320908465551; 0.4697822874053586; 0.14390600392910627; -0.22403618499416572; -0.07130921926705004; 0.0806126091510659; 0.03802993693503463; -0.01657454163101562; -0.012550998556013784; 0.00042957797300470274; 0.0018016407039998328; 0.0003537138000010399 |]
    transform h g a (Array.length a)
